name: llvm-x86_64-unknown-linux-musl

on:
  push:
    tags:
      - 'llvm-x86_64-unknown-linux-musl-v*.*.*'

jobs:
  build-llvm:
    runs-on: ubuntu-latest
  
    container:
      image: messense/rust-musl-cross:x86_64-musl

    permissions:
      contents: write
  
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
  
    steps:
      - name: Generating Unique ID
        run: |
          BASE_NAME=$(echo "$GITHUB_REF" | sed 's|^refs/tags/||')
          BUILD_ID="${BASE_NAME}-$GITHUB_RUN_ID" 
          
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "BASE_NAME=$BASE_NAME" >> $GITHUB_ENV

          echo "Unique ID: $BUILD_ID"
          echo "Base name: $BASE_NAME"
    
      - name: Installing dependencies
        run: |
          apk update
          apk add build-base cmake ninja python3 wget xz

      - name: Downloading LLVM project
        run: |
          wget https://github.com/llvm/llvm-project/releases/download/llvmorg-17.0.6/llvm-project-17.0.6.src.tar.xz

      - name: Unpacking LLVM project 
        run: |
          tar -xf llvm-project-17.0.6.src.tar.xz
          mv llvm-project-17.0.6.src llvm-project

      - name: Creating build directory
        run: |
          mkdir -p llvm-build

      - name: Configure LLVM build
        run: |
          cmake ../llvm-project/llvm -G Ninja \
            -DCMAKE_BUILD_TYPE=MinSizeRel \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++ \
            -DLLVM_ENABLE_PROJECTS="llvm;lld" \
            -DLLVM_ENABLE_TERMINFO=OFF \
            -DLLVM_ENABLE_ZLIB=OFF \
            -DLLVM_ENABLE_LIBXML2=OFF \
            -DCMAKE_INSTALL_PREFIX="dist" \
            -DLLVM_TARGETS_TO_BUILD="X86" \
            -DLLVM_BUILD_TESTS=OFF \
            -DLLVM_BUILD_EXAMPLES=OFF \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_DOCS=OFF \
            -DLLVM_BUILD_LLVM_DYLIB=ON \
            -DLLVM_LINK_LLVM_DYLIB=ON
        working-directory: llvm-build

      - name: Building LLVM tools first
        run: |
          # Primero construimos solo las herramientas esenciales
          ninja -j$(nproc) llvm-min-tblgen llvm-tblgen llvm-config
        working-directory: llvm-build

      - name: Verify tools are built
        run: |
          ls -la bin/llvm-min-tblgen
          file bin/llvm-min-tblgen
          ./bin/llvm-min-tblgen --version
        working-directory: llvm-build

      - name: Building complete LLVM
        run: |
          ninja -j$(nproc)
        working-directory: llvm-build

      - name: Installing LLVM
        run: |
          ninja install
        working-directory: llvm-build

      - name: Cleaning LLVM Binaries
        run: |
          find llvm-build/dist/bin -type f -executable ! -name "llvm-config" -delete

      - name: Preparing distribution files
        run: |
          mkdir -p tempDir/{lib,bin,include}
          
          cp -r llvm-build/dist/lib/* tempDir/lib/
          cp -r llvm-build/dist/bin/* tempDir/bin/
          cp -r llvm-build/dist/include/* tempDir/include/

      - name: Packaging LLVM
        run: |
          tar --format=pax -cJf llvm-x86_64-unknown-linux-musl.tar.xz lib bin include
        working-directory: tempDir

      - name: Releasing LLVM
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.BUILD_ID }}
          name: "llvm-x86_64-unknown-linux-musl"
          body: |
            ## llvm-x86_64-unknown-linux-musl
            LLVM libraries for llvm-x86_64-unknown-linux-musl for Thrush compiler compilation.
          files: |
            tempDir/llvm-x86_64-unknown-linux-musl.tar.xz
          draft: false